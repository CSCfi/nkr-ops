---

- name: Install zookeeper using ansible-zookeeper role
  include_role:
    name: ansible-zookeeper
  vars:
    data_dir: /data/zookeeper
    zookeeper_url: "https://archive.apache.org/dist/zookeeper/stable/apache-zookeeper-{{ zookeeper.version }}-bin.tar.gz"
    zookeeper_version: "{{ zookeeper.version }}"
    client_port: "{{ zookeeper.client_port }}"
    zookeeper_hosts: "
    {%- set ips = [] %}
    {%- for host in groups['indexservers'] %}
    {{- ips.append(dict(id=loop.index, host=host, ip=hostvars[host]['ansible_default_ipv4'].address)) }}
    {%- endfor %}
    {{- ips -}}"
    zookeeper_env: {
      "JAVA_HOME": "{{ ansible_local['java']['general']['home'] }}"
    }

- name: Add setting fixing zookeeper update issue
  lineinfile:
    dest: "{{ zookeeper_dir }}/conf/zoo.cfg"
    insertafter: "maxClientCnxns=.*"
    line: "snapshot.trust.empty=true"
    state: present
  vars:
    zookeeper_dir: "/opt/zookeeper-{{ zookeeper.version }}"

- name: Start zookeeper service
  systemd: name=zookeeper state=restarted daemon_reload=yes
  tags: deploy
